#!/bin/bash
set -e

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞ ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç (—Ç–µ–≥)
TARGET_TAG=$1

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f .env ]; then
    echo -e "${YELLOW}–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env...${NC}"
    set -o allexport
    source .env
    set +o allexport
fi

PROJECT_DIR="/home/balamut/projects/dns-filter"

cd "$PROJECT_DIR"

echo -e "${YELLOW}–û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (–≤–µ—Ç–∫–∏ –∏ —Ç–µ–≥–∏)...${NC}"
# –í–∞–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∞—Ç—å –≤—Å—ë, –∏–Ω–∞—á–µ –º—ã –Ω–µ —É–≤–∏–¥–∏–º —Å–≤–µ–∂–∏–µ —Ç–µ–≥–∏
git fetch --all --tags

if [ -n "$TARGET_TAG" ]; then
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–µ–≥–∞
    if git rev-parse --verify "refs/tags/$TARGET_TAG" >/dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ –¢–µ–≥ '$TARGET_TAG' –Ω–∞–π–¥–µ–Ω.${NC}"
        echo "–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Ç–µ–≥..."
        git checkout "tags/$TARGET_TAG"
    else
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –¢–µ–≥ '$TARGET_TAG' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏!${NC}"
        echo -e "${YELLOW}–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–≥–æ–≤:${NC}"
        git tag --sort=-creatordate | head -n 5
        exit 1
    fi
else
    echo -e "${YELLOW}‚ÑπÔ∏è  –¢–µ–≥ –Ω–µ —É–∫–∞–∑–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ç–∫—É main.${NC}"
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≤–µ—Ç–∫—É, –µ—Å–ª–∏ –±—ã–ª–∏ –Ω–∞ —Ç–µ–≥–µ
    git checkout main
    echo "–ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    git pull origin main
fi

# –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
echo -e "${GREEN}–°–æ–±–∏—Ä–∞–µ–º Docker-–æ–±—Ä–∞–∑ (–±–µ–∑ –∫—ç—à–∞)...${NC}"
docker compose build --no-cache

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo -e "${YELLOW}–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...${NC}"
docker compose down
docker compose up -d

echo -e "${GREEN}üöÄ –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ.${NC}"